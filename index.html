<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bass b00ster in browser</title>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      input[type="file"],
      audio,
      button {
        grid-column: 1 / -1;
      }
      body {
        display: grid;
        width: 10rem;
        grid: auto-flow / repeat(2, 1fr);
        gap: 1rem;
        padding: 1rem;
      }
      body * {
        max-width: 100%;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <input type="file" id="input" accept="audio/*" />
    <audio id="preview" controls></audio>
    <label for="frequency">Frequency:</label>
    <input
      type="number"
      min="1"
      max="11025"
      step="10"
      value="230"
      id="frequency"
    />
    <label for="gain">Gain: </label>
    <input type="number" min="-40" max="40" step="any" value="18" id="gain" />
    <label for="detune" class="hidden">Detune:</label>
    <input
      type="number"
      min="0"
      max="2000"
      step="any"
      value="650"
      id="detune"
      class="hidden"
    />
    <label for="q" class="hidden">Q: </label>
    <input
      type="number"
      min="0.0001"
      max="1000"
      step="any"
      value="1"
      id="q"
      class="hidden"
    />
    <label for="type" class="hidden">Type</label>
    <select id="type" class="hidden">
      <option>lowpass</option>
      <option>highpass</option>
      <option>bandpass</option>
      <option selected>lowshelf</option>
      <option>highshelf</option>
      <option>peaking</option>
      <option>notch</option>
      <option>allpass</option>
    </select>
    <button id="advanced">Advanced mode</button>
    <!-- <select id="preset"> </select> -->
    <script>
      const $ = (id) => document.getElementById(id);

      const previewAudio = $("preview");
      const fileInput = $("input");
      const typeLabel = document.querySelector('label[for="type"]');
      const typeSelect = $("type"); // lowshelf
      const frequencyInput = $("frequency"); // 230
      const detuneLabel = document.querySelector('label[for="detune"]');
      const detuneInput = $("detune"); // 650
      const qLabel = document.querySelector('label[for="q"]');
      const qInput = $("q"); // 63
      const gainInput = $("gain"); // 18
      const advancedButton = $("advanced");

      const ctx = new AudioContext();
      const previewNode = ctx.createMediaElementSource(
        document.getElementById("preview")
      );
      const filterNode = ctx.createBiquadFilter();
      filterNode.type = "lowshelf";
      filterNode.frequency.value = 230;
      filterNode.detune.value = 650;
      filterNode.gain.value = 18;
      previewNode.connect(filterNode);
      filterNode.connect(ctx.destination);

      fileInput.addEventListener("change", (e) => {
        if (!e.target.files.length) return;
        if (previewAudio.src) {
          URL.revokeObjectURL(previewAudio.src);
        }
        previewAudio.src = URL.createObjectURL(e.target.files[0]);
        ctx.resume();
      });
      typeSelect.addEventListener("change", () => {
        filterNode.type = typeSelect.options[typeSelect.selectedIndex].value;
      });
      frequencyInput.addEventListener("input", () => {
        filterNode.frequency.value = +frequencyInput.value;
      });
      detuneInput.addEventListener("input", () => {
        filterNode.detune.value = +detuneInput.value;
      });
      qInput.addEventListener("input", () => {
        filterNode.Q.value = +qInput.value;
      });
      gainInput.addEventListener("input", () => {
        filterNode.gain.value = +gainInput.value;
      });
      advancedButton.addEventListener("click", toggleAdvancedMode);

      function toggleAdvancedMode() {
        [
          detuneLabel,
          detuneInput,
          qLabel,
          qInput,
          typeLabel,
          typeLabel,
        ].forEach((el) => el.classList.toggle("hidden"));
      }
    </script>
  </body>
</html>
